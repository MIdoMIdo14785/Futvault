<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>FUTVault — Price list</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#071025;--card:#0b1724;--muted:#9aa4bf;--accent:#a8d4ff;--accent2:#cfe6df;--text:#e6eef9;
    --light-bg:#f0f3f5;--light-card:#fff;--light-text:#0b1724;
  }
  html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial;background:linear-gradient(180deg,var(--bg),#061022);color:var(--text)}
  .wrap{max-width:1100px;margin:28px auto;padding:18px}
  header{display:flex;align-items:center;gap:18px;margin-bottom:18px}
  .logo{width:64px;height:64px;border-radius:14px;overflow:hidden;background:linear-gradient(135deg,#0b74ff,#00c6ff);display:flex;align-items:center;justify-content:center}
  .logo img{width:100%;height:100%;object-fit:cover}
  h1{margin:0;font-size:20px}
  .lead{color:var(--muted);font-size:13px;margin-top:4px}
  .controls{display:flex;gap:12px;margin:18px 0;align-items:center;justify-content:space-between}
  .search{flex:1;display:flex;gap:8px}
  input.searchbox{flex:1;padding:12px 14px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:rgba(255,255,255,0.02);color:var(--text)}
  select.platform{padding:10px;border-radius:10px;background:rgba(255,255,255,0.02);border:none;color:var(--text)}
  button.refresh{padding:10px 14px;border-radius:10px;border:none;background:var(--accent);color:#072033;cursor:pointer}
  .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:22px;margin-top:18px}
  .card{background:var(--card);border-radius:14px;padding:18px;box-shadow:0 8px 20px rgba(2,6,12,0.6);display:flex;flex-direction:column;gap:12px}
  .cover{width:100%;height:360px;border-radius:12px;background:linear-gradient(180deg,#021024,#02101a);display:flex;align-items:center;justify-content:center;overflow:hidden}
  .cover img{width:100%;height:100%;object-fit:cover;border-radius:8px}
  .meta{font-weight:600}
  .platform-row{display:flex;gap:18px;align-items:flex-end;justify-content:center;margin-top:8px}
  .plat{background:rgba(255,255,255,0.02);padding:14px;border-radius:12px;min-width:120px;text-align:center;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
  .plat h4{margin:0;font-size:14px;color:var(--muted)}
  .price-box{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:10px}
  .price{min-width:120px;padding:12px 18px;border-radius:10px;background:var(--accent);color:#072033;font-weight:700;box-shadow:0 6px 18px rgba(2,6,12,0.4)}
  .price.secondary{background:var(--accent2);color:#072033}
  .label{font-size:13px;color:var(--muted);margin-top:6px}
  .duration-buttons{display:flex;gap:8px;justify-content:center;margin-top:10px}
  .duration-buttons button{padding:8px 12px;border-radius:8px;border:1px solid rgba(0,0,0,0.08);background:#fff;color:#123;border-weight:600;cursor:pointer}
  .small-note{font-size:13px;color:var(--muted);margin-top:8px}
  .error{color:#ff6b6b;font-weight:700}
  /* Light mode */
  :root.light{--bg:#e9f0f3;--card:var(--light-card);--text:var(--light-text);--muted:#6b7380}
  .top-right{display:flex;gap:12px;align-items:center}
  .toggle{padding:8px 12px;border-radius:14px;background:rgba(255,255,255,0.06);cursor:pointer}
  @media(max-width:520px){.cover{height:260px}}
</style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="logo"><img src="assets/logo.png" alt="logo" id="siteLogo" onerror="this.style.display='none'"></div>
      <div>
        <h1>FUTVault — Price list</h1>
        <div class="lead">Catalogue professionnel</div>
      </div>
      <div style="flex:1"></div>
      <div class="top-right">
        <button id="modeToggle" class="toggle">Mode clair</button>
      </div>
    </header>

    <div class="controls">
      <div class="search">
        <input id="searchInput" class="searchbox" placeholder="Rechercher (titre, SKU, keywords)..." />
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <select id="platformFilter" class="platform">
          <option value="all">Toutes plateformes</option>
          <option value="ps5">PS5</option>
          <option value="ps4">PS4</option>
        </select>
      </div>
    </div>

    <div id="message" class="small-note"></div>
    <div id="grid" class="grid"></div>
  </div>

<script>
(async function(){
  const grid = document.getElementById('grid');
  const msg = document.getElementById('message');
  const search = document.getElementById('searchInput');
  const filter = document.getElementById('platformFilter');
  const modeBtn = document.getElementById('modeToggle');
  let data = [], duration = '12m'; // default: show 12m prices
  // load JSON
  try{
    const res = await fetch('data/games.json', {cache: "no-store"});
    if(!res.ok) throw new Error('JSON fetch failed: ' + res.status);
    data = await res.json();
  } catch(e){
    msg.innerHTML = '<span class="error">Erreur chargement data</span>';
    console.error(e);
    return;
  }

  // utilities
  function hasPlatform(item, plat){
    if(item.category==='subscription') {
      return !!item.prices && !!item.prices[plat];
    } else {
      return !!item.platforms && !!item.platforms[plat];
    }
  }
  function formatPrice(v){ if(v===undefined||v===null) return '-'; if(v==='-') return '-'; return (typeof v==='number'? v + ' DHS': v); }
  function createCard(item){
    const c = document.createElement('div'); c.className='card';
    // cover
    const cover = document.createElement('div'); cover.className='cover';
    const img = document.createElement('img');
    img.src = (item.image || '/assets/placeholder-800.webp');
    img.alt = item.name;
    img.loading = 'lazy';
    img.onerror = function(){ this.src='/assets/placeholder-800.webp' };
    cover.appendChild(img);
    c.appendChild(cover);
    // title
    const title = document.createElement('div'); title.innerHTML = '<div class="meta">'+item.name+'</div>';
    c.appendChild(title);
    // durations buttons (centered under title)
    const durWrap = document.createElement('div'); durWrap.className='duration-buttons';
    const btn6 = document.createElement('button'); btn6.textContent='6 mois';
    const btn12 = document.createElement('button'); btn12.textContent='12 mois';
    btn6.onclick = ()=>{ duration='6m'; render(); };
    btn12.onclick = ()=>{ duration='12m'; render(); };
    durWrap.appendChild(btn6); durWrap.appendChild(btn12);
    c.appendChild(durWrap);

    // platform row
    const prow = document.createElement('div'); prow.className='platform-row';
    // helper to build plat box
    function buildPlatBox(label, obj, isSubscription=false){
      const p = document.createElement('div'); p.className='plat';
      const h = document.createElement('h4'); h.textContent = label; p.appendChild(h);
      const priceRow = document.createElement('div'); priceRow.className='price-box';
      // Primary
      const primary = document.createElement('div'); primary.className='price';
      let primaryVal = '-';
      if(isSubscription){
        if(obj && obj.principal && obj.principal[duration]!==undefined) primaryVal = obj.principal[duration];
      } else {
        if(obj && obj.principal!==undefined) primaryVal = obj.principal;
      }
      primary.textContent = formatPrice(primaryVal);
      priceRow.appendChild(primary);
      // Secondary (only if exists)
      const secondaryVal = (isSubscription && obj && obj.secondaire && obj.secondaire[duration]!==undefined) ? obj.secondaire[duration] : ( !isSubscription && obj && obj.secondaire!==undefined ? obj.secondaire : '-' );
      const secondary = document.createElement('div'); secondary.className='price secondary'; secondary.textContent = formatPrice(secondaryVal);
      priceRow.appendChild(secondary);
      p.appendChild(priceRow);
      // labels
      const l1 = document.createElement('div'); l1.className='label'; l1.textContent='Principal';
      const l2 = document.createElement('div'); l2.className='label'; l2.textContent='Secondaire';
      p.appendChild(l1); p.appendChild(l2);
      // hide secondary if '-'
      if(secondaryVal === '-' || secondaryVal === null) { secondary.style.visibility='hidden'; l2.style.visibility='hidden'; }
      return p;
    }

    if(item.category === 'subscription'){
      const ps5obj = item.prices.ps5 || null;
      const ps4obj = item.prices.ps4 || null;
      prow.appendChild(buildPlatBox('PS5', ps5obj, true));
      prow.appendChild(buildPlatBox('PS4', ps4obj, true));
    } else {
      // games: show PS5 and PS4 if exist; if only PS5 center it
      const ps5exists = !!(item.platforms && item.platforms.ps5);
      const ps4exists = !!(item.platforms && item.platforms.ps4);
      if(ps5exists && ps4exists){
        prow.appendChild(buildPlatBox('PS5', item.platforms.ps5));
        prow.appendChild(buildPlatBox('PS4', item.platforms.ps4));
      } else if(ps5exists){
        const box = buildPlatBox('PS5', item.platforms.ps5);
        box.style.margin = '0 auto';
        prow.appendChild(box);
      } else if(ps4exists){
        const box = buildPlatBox('PS4', item.platforms.ps4);
        box.style.margin = '0 auto';
        prow.appendChild(box);
      } else {
        const none = document.createElement('div'); none.textContent='No platform info'; none.style.color='var(--muted)';
        prow.appendChild(none);
      }
    }

    c.appendChild(prow);
    return c;
  }

  // render function (based on filter & search)
  function render(){
    grid.innerHTML = '';
    msg.innerHTML = '';
    const q = search.value.trim().toLowerCase();
    const platFilter = filter.value;
    // ordering: desired order: ps+ essential / extra / premium then games order defined in JSON
    const ordered = data.slice(); // respect JSON order
    let shown=0;
    for(const item of ordered){
      // platform filter
      if(platFilter!=='all'){
        if(item.category==='subscription'){
          if(!hasPlatform(item, platFilter)) continue;
        } else {
          if(!hasPlatform(item, platFilter)) continue;
        }
      }
      // search filter
      if(q){
        const inName = item.name && item.name.toLowerCase().includes(q);
        const inId = item.id && item.id.toLowerCase().includes(q);
        const inKeywords = (item.keywords || []).join(' ').toLowerCase().includes(q);
        if(!(inName || inId || inKeywords)) continue;
      }
      // create card
      const card = createCard(item);
      grid.appendChild(card);
      shown++;
    }
    if(shown===0) msg.innerHTML = '<span class="small-note">Aucun résultat</span>';
  }

  // initial render
  render();

  // events
  search.addEventListener('input', ()=>render());
  filter.addEventListener('change', ()=>render());
  // light/dark mode toggle
  modeBtn.addEventListener('click', ()=>{
    document.documentElement.classList.toggle('light');
    modeBtn.textContent = document.documentElement.classList.contains('light') ? 'Mode nuit' : 'Mode clair';
  });

})();
</script>
</body>
</html>
